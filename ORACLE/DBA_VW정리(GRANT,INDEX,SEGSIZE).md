# DBA 작업용 View 테이블 생성 쿼리

 ## VW_DBA_GRANT_DDL 
 ```sql
CREATE OR REPLACE VIEW OWN.VW_DBA_GRANT_DDL 
AS 
SELECT OWNER, TABLE_NAME, GRANTEE 
		, 'GRANT ' || LISTAGG( PRIVILEGE , ' , '  ) WITHIN GROUP ( ORDER BY PRIVILEGE )
			 || ' ON ' || OWNER || '.' || TABLE_NAME || ' TO ' || GRANTEE || ';'
			 GRANT_DDL
FROM DBA_TAB_PRIVS A 
GROUP BY OWNER, TABLE_NAME, GRANTEE;
```


## VW_DBA_IDEX_DDL 
```sql
CREATE OR REPLACE VIEW OWN.VW_DBA_INDEX_DDL
AS
SELECT B.INDEX_OWNER OWNER,
       B.TABLE_NAME,
       B.INDEX_NAME, 
       MAX(A.INDEX_TYPE) TYPE, 
		NVL(( SELECT 'Y' FROM DBA_CONSTRAINTS X WHERE X.CONSTRAINT_TYPE = 'P' AND 
				X.OWNER = B.INDEX_OWNER AND X.CONSTRAINT_NAME = B.INDEX_NAME ), '') PK,
		DECODE(D.LOCALITY, 'LOCAL', 'LOCAL', NULL) PARTITIONED, 
		LISTAGG ( B.COLUMN_NAME, ', ') WITHIN GROUP ( ORDER BY B.COLUMN_POSITION) COL_LIST,
		NVL(A.TABLESPACE_NAME , D.DEF_TABLESPACE_NAME) TABLESPACE_NAME,
		(SELECT SUM(BYTES)/1024/1024 FROM DBA_SEGMENTS X WHERE X.OWNER = B.INDEX_OWNER AND 
			X.SEGMENT_NAME = B.INDEX_NAME ) INDEX_SIZE_MB, 
		CASE WHEN B.INDEX_NAME LIKE 'PK%' then 
			'ALTER TABLE ' || B.TABLE_OWNER || '."' || B.TABLE_NAME || '" DROP PRIMARY KEY;' ELSE '' END PK_DROP_DDL,
		'DROP INDEX ' || B.INDEX_OWNER || '."' || B.INDEX_NAME || '";' INDEX_DROP_DDL,		
		'CREATE ' || DECODE( A.UNIQUENESS, 'UNIQUE', 'UNIQUE', NULL ) || ' INDEX '  || B.INDEX_OWNER || '."' || B.INDEX_NAME || '" ON '
			|| B.TABLE_OWNER || '."' || B.TABLE_NAME || '"(' 
			|| LISTAGG(B.COLUMN_NAME , ', ' ) WITHIN GROUP (ORDER BY B.COLUMN_POSITION) || ') TABLESPACE '
			|| NVL( A.TABLESPACE_NAME, D.DEF_TABLESPACE_NAME) || ' '
			|| DECODE(D.LOCALITY, 'LOCAL', 'LOCAL', NULL)
			|| ' PARALLEL 4 NOLOGGING;' CREATE_INDEX_DDL ,
		CASE WHEN B.INDEX_NAME LIKE 'PK%' THEN 
			'ALTER TABLE ' || B.TABLE_OWNER || '."' || B.TABLE_NAME || '" ADD CONSTRAINT "'|| B.INDEX_NAME || '" PRIMARY KEY (' 
				|| LISTAGG(B.COLUMN_NAME, ', ') WITHIN GROUP (ORDER BY B.COLUMN_POSITION) 
				|| ') USING INDEX;' ELSE '' END CREATE_PK_DDL,
		'ALTER INDEX ' || B.INDEX_OWNER || '."' || B.INDEX_NAME || '" LOGGING NOPARALLEL;' ALTER_INDEX_DDL 
FROM DBA_INDEXES A , 
	 DBA_IND_COLUMNS B, 
	 DBA_PART_INDEXES D
WHERE 1=1
	-- AND A.OWNER = 'OWN'
	AND A.OWNER = B.INDEX_OWNER 
	AND A.INDEX_NAME =B.INDEX_NAME 
	AND A.OWNER = D.OWNER(+) 
	AND A.INDEX_NAME = D.INDEX_NAME(+) 
	AND A.TABLE_NAME NOT LIKE 'BIN$%' 
	AND A.TABLE_NAME NOT LIKE 'SYS$%' 
	AND A.INDEX_TYPE <>'LOB'
GROUP BY B.INDEX_OWNER , B.INDEX_NAME, B.TABLE_OWNER ,B.TABLE_NAME 
		, DECODE( A.UNIQUENESS, 'UNIQUE', 'UNIQUE', NULL )
		, DECODE(D.LOCALITY, 'LOCAL', 'LOCAL', NULL)
		, NVL( A.TABLESPACE_NAME, D.DEF_TABLESPACE_NAME)
ORDER BY B.INDEX_OWNER, B.TABLE_NAME ,B.INDEX_NAME;
```


## VW_DBA_SEG_SIZE
```sql
SELECT OWNER, TABLE_NAME, TABLESPACE_NAME, SUM(MB) MB, MAX(CLOB_YN) CLOB_YN,
	DECODE(SUM(PARTITIONED),1,NULL,SUM(PARTITIONED)) PARTITIONED
FROM 
	(SELECT OWNER, SEGMENT_NAME TABLE_NAME , TABLESPACE_NAME , SUM(BYTES)/1024/1024 MB, 
		'' CLOB_YN , COUNT(*) PARTITIONED 
	FROM DBA_SEGMENTS A 
	WHERE 1=1 
		-- AND A.SEGMENT_NAME NOT LIKE '%#_202$' ESCAPE '#'
		AND A.SEGMENT_NAME NOT LIKE '%$%' 
		AND SEGMENT_TYPE LIKE 'TABLE%'
	GROUP BY OWNER, SEGMENT_NAME ,TABLESPACE_NAME 
	UNION ALL 
	SELECT A.OWNER,A.TABLE_NAME, A.TABLESPACE_NAME, SUM(B.BYTES)/1024/1024 MB , 
			'Y' CLOB_YN , 0 PARTITIONED 
	FROM DBA_LOBS A , DBA_SEGMENTS B
	WHERE 1=1 
		-- AND A.TABLE_NAME NOT LIKE '%#_202$' ESCAPE '#'
		AND A.TABLE_NAME NOT LIKE '%$%' 
		AND A.OWNER = B.OWNER 
		AND A.SEGMENT_NAME = B.SEGMENT_NAME 
	GROUP BY A.OWNER, A.TABLE_NAME, A.TABLESPACE_NAME)
GROUP BY OWNER, TABLE_NAME , TABLESPACE_NAME ORDER BY 4
```